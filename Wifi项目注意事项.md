### 协议版本

PV=01——这是旧版本的通讯协议，使用AES加密。

PV=A1——这是新版本的通讯协议，使用SSL加密。

如无特殊原因，PV=01的协议，只在历史遗留项目中使用，新项目一律使用PV=A1。

###WiFi模块

让WiFi模块连上路由器的技术，不同的模块厂家提供了不同的技术：

厂家：汉枫——技术：SmartLink

厂家：庆科——技术：EasyLink

厂家：利尔达——技术：EasyJoin

APP可以一次添加一个WiFi设备。以汉枫的模块为例，某个设备进入配置状态，通过SmarkLink技术连上路由器后，APP上会执行一个回调函数，通过该回调函数，能够知道该设备的MAC地址和IP地址。

APP也可以一次添加多个WiFi设备。这时候并不依赖于SmartLink等技术的回调函数，SmartLink只是用来让设备连上路由器。APP在发送SmartLink信号的同时，不断的对外发送0x23广播，并且发送出去的数据包，MAC地址为FF:FF:FF:FF:FF:FF，在局域网内的未锁定的设备，都会响应，并且回复的数据包中，有设备的MAC地址和IP地址。

至于一次添加一个设备，还是一次添加多个设备，由客户需求决定。
###Socket编程

1、局域网内的UDP广播地址，可以使用255.255.255.255，但有些手机或路由器可能对它不予理睬。最可靠的做法是自己计算出子网内的真实的广播地址。

2、UDP广播容易丢包。手机发出的UDP广播，应当重复发送。对于设备发出的广播，例如GPIO口状态变化事件，除了对该事件做接收处理外，不应过分依赖广播事件反馈状态，应该允许用查询命令进行状态更新。

3、不论Android还是iOS系统，有些手机默认不接收UDP广播包，以便节省电量。因此一定要记得启用手机的接收UDP广播的功能。

4、APP程序中，UDP部分，至少有3个独立的线程：1个UDP发送线程，1个UDP接收线程，1个UDP数据处理线程（也可以是线程池）。发送线程和接收线程，使用的是同一个UDP Socket。接收线程接收到数据后，应该交给数据处理线程。

5、APP程序中，TCP部分，至少有3个独立的线程：1个TCP发送线程，1个TCP接收线程，1个TCP数据处理线程（也可以是线程池）。发送线程和接收线程，使用的是同一个TCP Socket。接收线程接收到数据后，应该交给数据处理线程。

6、APP与服务器建立TCP长连接的时候，连接可能不成功，要有重连机制。

7、APP与服务器的TCP长连接，可能会断开，需要依赖于心跳包(**心跳包主要是用于长连接的保活和断线处理,为了保持长连接，至于这个包的内容，是没有什么特别规定的，不过一般都是很小的包，或者只包含包头的一个空包**)来判断连接状态，如果断开则需要重连。

8、为了提高TCP传输的实时性，记得设置参数TCP_NODELAY = TRUE。

![](images/WiFi_APP_Network_Init.png)
注意：对于每个设备，应该有2个变量，分别标识其是否在局域网内、远程是否在线，只有两者皆为否，才表示设备离线。